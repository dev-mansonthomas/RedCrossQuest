<acme-navbar></acme-navbar>
<div class="container" data-ng-controller="RetourTroncController as rt">


  <div class="panel panel-primary"  style="background-color: #5bc0de!important;border-color:#5bc0de!important;">
    <div class="panel-heading" style="background-color: #5bc0de!important;border-color:#5bc0de!important;"><h2>Retour Tronc</h2>
      <span ng-show="rt.current.tronc_queteur.id">
        ID {{rt.current.tronc_queteur.id}} -
  Tronc N° {{rt.current.tronc.id}} -
           {{rt.current.tronc_queteur.queteur.first_name}}
           {{rt.current.tronc_queteur.queteur.last_name}} -
           {{rt.current.tronc_queteur.queteur.nivol}} -
        parti depuis '<b>{{rt.current.tronc_queteur.departStr}}</b>'
        du point de quête '<b>{{rt.current.tronc_queteur.point_quete.name}}</b>'</span></div>
  </div>


  <div class="col-xs-12">
    <div class="well">
        <form novalidate ng-submit='rt.save();' name="retourTroncForm">
          <div class="row">
            <div class="form-group col-md-4"  style="text-align:center;" ng-if="!rt.current.readOnlyView">

              <qr-scanner-u
                ng-success="rt.qrCodeScanOnSuccess(data)"
                ng-error="rt.qrCodeScanOnError(error)"
                ng-video-error="rt.qrCodeScanOnVideoError(error)"
                width="320"
                height="200"></qr-scanner-u>

              <span class="help-block" ng-bind="departTronc.decodedData"></span>
            </div>
            <div class="col-md-8">
              <div class="row">
                <div class="form-group  col-md-6" ng-class="{'has-error':retourTroncForm.troncId.$invalid}">
                  <label for="troncId" class="control-label">Id Tronc</label>
                  <input
                    id="troncId"
                    type="text"
                    ng-model="rt.current.tronc"
                    placeholder="Scanner le QRCode du tronc"
                    uib-typeahead="tronc as tronc.id for tronc in rt.searchTronc($viewValue)"
                    typeahead-loading="loadingTroncs"
                    typeahead-no-results="noTroncsResults"
                    typeahead-wait-ms="20"
                    class="form-control"
                    ng-required
                    ng-disabled="rt.current.readOnlyView"
                    autocomplete="off">
                  <i   ng-show="loadingTroncs" class="glyphicon glyphicon-refresh"></i>
                  <div ng-show="noTroncResults">
                    <i class="glyphicon glyphicon-remove"></i> Aucun Tronc trouvé
                  </div>

                  <span class="help-block">Scan QR Code, avec mode secours saisie manuelle</span>
                </div>



                <div class="form-group col-md-6" ng-class="{'has-error':retourTroncForm.retour.$invalid}" ng-show="rt.current.tronc_queteur.id>0">
                  <label for="retour" class="control-label">Horaire réelle de Retour</label>
                  <input name="retour"
                         id="retour"
                         type="datetime-local"
                         class="form-control"
                         ng-model="rt.current.tronc_queteur.retour"
                         ng-min="rt.current.tronc_queteur.depart"
                         ng-max="rt.current.tronc_queteur.retourMax"
                         required/>

                  <span class="help-block" ng-show="rt.current.fillTronc">
                    La date de retour est <b>déjà</b> enregistrée, vous êtes en train de l'éditer ! <br/>
                    <strong>ATTENTION</strong><br/>
                    Si vous pensiez faire un premier enregistrement de la date de retour, c'est que la préparation et le départ ont été raté!<br/>
                    Cliquez sur <b>cancel</b>, et faites une préparation tronc, départ, puis enregistrez le retour!
                  </span>

                  <span class="help-block" ng-show="retourTroncForm.retour.$invalid">
                    La date de retour doit être postérieur à la date de départ <br/>
                    Et avant la date actuelle.
                  </span>
                </div>
              </div>
              <div class="row">
                <div class="col-md-8 col-md-offset-4">
                  <div class="alert alert-info" role="alert" style="text-align: center;vertical-align: middle;">
                    <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true" style="font-size:40px;color:green;"></span>
                    N'oubliez pas de cliquer sur le bouton <b>"Save"</b>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <div class="row" ng-show="rt.savedSuccessfully">
            <div class="col-md-8 col-md-offset-2">
              <div class="alert alert-success alert-dismissible" role="alert" style="text-align: center;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close" ng-click="rt.savedSuccessfully=false"><span aria-hidden="true">&times;</span></button>
                <strong>Bravo!</strong> L'horaire de retour a été sauvegardé avec succès!
              </div>
            </div>
          </div>

          <div class="row" ng-hide="rt.checkDeltaDepartRetourIsCorrect()">
            <div class="col-md-8 col-md-offset-2">
              <div class="alert alert-danger alert-dismissible" role="alert" style="text-align: left;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close" ng-click="rt.initForm();"><span aria-hidden="true">&times;</span></button>
                <span class="glyphicon glyphicon-ban-circle" aria-hidden="true" style="font-size:40px;color:red;"></span>
                La date de retour et la date de départ sont séparrées <b>de plus de 24 heures</b><br/>
              </div>
            </div>
          </div>



          <div class="row" ng-show="rt.current.tronc_queteur.troncFromPreviousYear">
            <div class="col-md-8 col-md-offset-2">
              <div class="alert alert-danger alert-dismissible" role="alert" style="text-align: left;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close" ng-click="rt.initForm();"><span aria-hidden="true">&times;</span></button>
                <span class="glyphicon glyphicon-ban-circle" aria-hidden="true" style="font-size:40px;color:red;"></span>
                Le tronc N°<strong>{{rt.current.tronc.id}}</strong> de
                <strong>{{rt.current.tronc_queteur.queteur.first_name}}
                  {{rt.current.tronc_queteur.queteur.last_name}}</strong> est un tronc de l'année {{rt.current.tronc_queteur.troncFromPreviousYearYEAR}}!<br/>
              </div>
            </div>
          </div>
          <div class="row" ng-show="rt.current.tronc_queteur.dateDepartIsMissing === true">
            <div class="col-md-8 col-md-offset-2">
              <div class="alert alert-danger alert-dismissible" role="alert" style="text-align: left;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close" ng-click="rt.initForm();"><span aria-hidden="true">&times;</span></button>
                <span class="glyphicon glyphicon-ban-circle" aria-hidden="true" style="font-size:40px;color:red;"></span>
                Le tronc N°<strong>{{rt.current.tronc.id}}</strong> de
                <strong>{{rt.current.tronc_queteur.queteur.first_name}}
                  {{rt.current.tronc_queteur.queteur.last_name}}</strong> n'a pas de date de départ saisie !<br/>
                <br/>
                <strong><u>Veuillez saisir la date de départ du tronc</u></strong>
                <ul>
                  <li>Demandez au quêteur à quelle heure il est parti pour ce créneau</li>
                  <li>Et renseigner la date ci-dessous (elle ne peut être postérièure à la date de retour et égale à 00h00min</li>
                </ul>

                <div class="form-group" ng-class="{'has-error':retourTroncForm.depart.$invalid}">
                  <label for="depart" class="control-label">Horaire Départ Réelle</label>
                  <input name="depart"
                           id="depart"
                         type="datetime-local"
                        class="form-control"
                     ng-model="rt.current.tronc_queteur.depart"
                       ng-min="rt.current.tronc_queteur.depart_theorique"
                       ng-max="rt.current.tronc_queteur.retour"
                  ng-required="rt.current.tronc_queteur.dateDepartIsMissing === true"/>

                  <span class="help-block" ng-show="retourTroncForm.depart.$error.required">Required</span>

                  <span class="help-block">Le départ doit être après l'heure de départ théorique : {{rt.current.tronc_queteur.depart_theoriqueStr}}<br/>
                  Le départ théorique peut être modifié par l'administrateur local (quêteur->recherche du quêteur (nivol:{{rt.current.tronc_queteur.queteur.nivol}})->selection du tronc (id:{{rt.current.tronc_queteur.id}})->mode admin</span>
                </div>

              </div>
            </div>
          </div>

          <div class="row" ng-show="rt.current.tronc_queteur.id">
            <div class="col-md-8 col-md-offset-2">
              <label for="notesPreparation" class="control-label">Notes à la préparation</label>
              <textarea
                id="notesPreparation"
                name="notesPreparation"
                ng-model="rt.current.tronc_queteur.notes_depart_theorique"
                class="form-control"
                disabled
              ></textarea>
              <br/>
            </div>
          </div>

          <div class="row" ng-show="rt.current.tronc_queteur.id">
            <div class="col-md-8 col-md-offset-2">
              <label for="notesRetour" class="control-label">Notes au retour</label>
              <textarea
                id="notesRetour"
                name="notesRetour"
                ng-model="rt.current.tronc_queteur.notes_retour"
                class="form-control"
                ng-maxlength="500"
                ng-trim="true"
              ></textarea>
              <br/>
            </div>
          </div>


          <div class="row" >
            <div class="form-group col-md-2 col-md-offset-10">
              <input type="submit"
                     class="btn btn-primary"
                     value="Save"
                     ng-disabled="retourTroncForm.$invalid ||
                     rt.current.tronc_queteur.dateDepartIsMissing === true && rt.current.tronc_queteur.depart.getHours() == 0 && rt.current.tronc_queteur.depart.getMinutes() == 0 ||
                     rt.current.tronc_queteur.troncFromPreviousYear ||
                     !rt.checkDeltaDepartRetourIsCorrect()" />
              <a  ng-click="rt.back();" class="btn btn-link">Cancel</a>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>
