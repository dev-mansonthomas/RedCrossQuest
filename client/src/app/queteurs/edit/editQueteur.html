<acme-navbar></acme-navbar>

<div class="container" data-ng-controller="QueteurEditController as queteur">

  <div class="panel panel-primary">
    <div class="panel-heading">Un Quêteur:  <b><span ng-bind="queteur.current.first_name"></span> <span ng-bind="queteur.current.last_name"></span></b></div>

   </div>

  <div class="well">
    <form novalidate name="queteurForm">


      <div class="row">
        <div class="col-md-4 col-md-offset-2">
          <div class="form-group" ng-class="{'has-error':queteurForm.first_name.$invalid}">
            <label for="first_name" class="control-label">First name</label>
            <input name="first_name" id="first_name" class="form-control" ng-model="queteur.current.first_name" required />
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group" ng-class="{'has-error':queteurForm.last_name.$invalid}">
            <label for="last_name" class="control-label">Last name</label>
            <input name="last_name" id="last_name" class="form-control" ng-model="queteur.current.last_name" required />
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 col-md-offset-2">
          <div class="form-group" ng-class="{'has-error':queteurForm.man.$invalid}">
            <label for="manRadio1" class="control-label">Sexe</label>  <br/>
            <label class="radio-inline">
              <input type="radio" name="man" id="manRadio1" ng-model="queteur.current.man" value="1" required> Homme
            </label>
            <label class="radio-inline">
              <input type="radio" name="man" id="manRadio2" ng-model="queteur.current.man" value="0" required> Femme
            </label>
          </div>
        </div>

        <div class="form-group col-md-4" ng-class="{'has-error':queteurForm.birthdate.$invalid}">
          <label for="birthdate" class="control-label">Date de naissance</label>
          <div class="input-group">
            <span class="input-group-addon" ng-class="{'majeur':queteur.current.age>=18, 'mineur':queteur.current.age<18}">{{queteur.current.age}}</span>
            <input name="birthdate" id="birthdate"
                   type="date"
                   class="form-control"
                   required
                   ng-model="queteur.current.birthdate"
                   ng-min="queteur.oldestBirthDate"
                   ng-max="queteur.youngestBirthDate"
                   ng-change="queteur.computeAge()"/>
          </div>
          <span class="help-block" ng-show="queteurForm.birthdate.$invalid">La date de naissance n'est utilisée que pour savoir si la personne est majeur ou non. La date exacte est importante que pour les mineurs.</span>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 col-md-offset-2">

          <div class="form-group" ng-class="{'has-error':queteurForm.email.$invalid}">
            <label for="email" class="control-label">Email</label>
            <div class="input-group">
              <span class="input-group-addon" id="basic-addon1">@</span>
              <input name="email" id="email" class="form-control" type="email" ng-model="queteur.current.email" required/>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group" ng-class="{'has-error':queteurForm.active.$invalid}">
            <label for="activeRadio1" class="control-label">Actif</label> <br/>
            <label class="radio-inline">
              <input type="radio" name="active" id="activeRadio1" ng-model="queteur.current.active" value="1" required> Oui
            </label>
            <label class="radio-inline">
              <input type="radio" name="active" id="activeRadio2" ng-model="queteur.current.active" value="0" required> Non
            </label>
          </div>
        </div>
      </div>


      <div class="row">
        <div class="col-md-4 col-md-offset-2">
          <div class="form-group">
            <label for="secteur" class="control-label">Secteur</label>
            <select name="secteur" id="secteur" class="form-control" ng-model="queteur.current.secteur" required
                    ng-options="(r.id+'') as r.label
                      for
                      r in queteur.typeBenevoleList"

            >
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="ul_id" class="control-label">Unité Locale</label>
            <select name="ul_id" id="ul_id" class="form-control" ng-model="queteur.current.ul_id">
              <option value="{{::queteur.current.ul_id}}" selected>{{::queteur.current.ul_name}}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 col-md-offset-2">
          <div class="form-group" ng-class="{'has-error':queteurForm.mobile.$invalid}">
            <label for="mobile" class="control-label">Téléphone</label>
            <div class="input-group">
              <span class="input-group-addon glyphicon glyphicon-phone-alt" aria-hidden="true" id="basic-addon2" style="top:0px;">&nbsp;+</span>
              <input name="mobile" id="mobile" class="form-control"  type="number" ng-model="queteur.current.mobile" required ng-pattern="'33[6-7][0-9]{8,8}'" />
            </div>
            <span class="help-block" ng-show="queteurForm.mobile.$invalid">Format : +33601020304 <br/><sub>(Ne <b>pas</b> mettre le +). seul les numéros français sont autorisés)</sub><br/>Si le quêteur n'a pas de mobile, mettre le téléphone de son parrain.</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group" ng-class="{'has-error':queteurForm.nivol.$invalid}" ng-show="queteur.current.secteur == 1 || queteur.current.secteur == 2 || queteur.current.secteur == 4">
            <label for="nivol" class="control-label">NIVOL</label>
            <input name="nivol" id="nivol" class="form-control"
                   ng-model="queteur.current.nivol"
                   ng-required="queteur.current.secteur == 1 || queteur.current.secteur == 2 || queteur.current.secteur == 4"
                   ng-pattern="'[0-9]{3,11}[A-Z]'"
            />
            <span class="help-block" ng-show="queteurForm.nivol.$invalid">NIVOL : Numéro d'Identifiant VOLontaire.<br/> <sub>Mettre 1000A si inconnu<br/> (mais faites un effort quand même pour le trouver)</sub></span>
          </div>

          <div class="form-group" ng-class="{'has-error':queteurForm.referent_volunteer.$invalid}" ng-show="queteur.current.secteur == 3"> <!-- Non Bénévole -->
            <label for="referent_volunteer" class="control-label">Bénévole Référent</label>

            <input
              id="referent_volunteer"
              name="referent_volunteer"
              type="text"
              ng-model="queteur.current.referent_volunteerQueteur"
              placeholder="Scanner le QRCode de la carte du quêteur"
              uib-typeahead="queteur as queteur.full_name for queteur in queteur.searchQueteur($viewValue)"
              typeahead-loading="loadingQueteurs"
              typeahead-no-results="noResults"
              typeahead-wait-ms="20"
              class="form-control"
              ng-required="queteur.current.secteur == 3"
              autocomplete="off"/>
            <i   ng-show="loadingQueteurs" class="glyphicon glyphicon-refresh"></i>
            <div ng-show="noResults">
              <i class="glyphicon glyphicon-remove"></i> Aucun Queteur trouvé
            </div>

            <span class="help-block" ng-show="queteurForm.referent_volunteer.$invalid">Indiquer le bénévole qui amène ce quêteur d'un jour<br/><sub>Recherche par nom, prénom, NIVOL</sub> S'il n'y en a pas, mettre le président de l'UL.</span>

          </div>


        </div>
      </div>
      <div class="row" ng-show="queteur.current.secteur >= 3" style="padding-bottom:15px;">
        <div class="col-md-8 col-md-offset-2">
          <h3><span class="label label-warning">Attention !</span> Quêteur d'un jour - Formulaire à remplir !</h3>
          <span class="help-block">Téléchargez le(s) formulaire(s), imprimez le(s), faites le(s) remplir et signer par le quêteur d'un jour (et parents), puis scannez les documents et attachez les à ce formulaire.</span>

          <div class="col-md-4 col-md-offset-2">
            <a href="/assets/docs/RCQ-QueteurUnJourEtMentionCNIL.pdf" target="_blank"><span class="glyphicon glyphicon-list-alt"   ></span>&nbsp;Formulaire Quêteur d'un Jour</a>
          </div>
          <div class="col-md-4 col-md-offset-2" ng-show="queteur.current.age < 18">
            <a href="/assets/docs/RCQ-AutorisationParentale.pdf"      target="_blank"><span class="glyphicon glyphicon-thumbs-up"></span>&nbsp;Autorisation Parentale</a>
          </div>
        </div>
      </div>
      <div class="row" ng-show="queteur.current.secteur >= 3">
        <div class="col-md-4 col-md-offset-2">
          <div class="form-group">

            <label for="temporary_volunteer_form" class="control-label">Formulaire du Quêteur occasionel</label>
            <input type="file"
                   name="temporary_volunteer_form"
                   id="temporary_volunteer_form"
                   ng-model="temporary_volunteer_form"
                   ngf-max-size="2MB"
                   ngf-accept="'image/*', 'application/pdf'"
                   ngf-model-invalid="errorFile"
            />
            <span class="help-block">Scanner le formulaire de bénévole occasionnel et ajouter le fichier ici</span>
            <span class="help-block" ng-show="queteurForm.temporary_volunteer_form.$error.maxSize">Scanner le formulaire de bénévole occasionnel et ajouter le fichier ici</span>
            <span class="progress" ng-show="queteur.current.temporary_volunteer_form.progress >= 0">
              <div style="width:{{queteur.current.temporary_volunteer_form.progress}}%"
                 ng-bind="queteur.current.temporary_volunteer_form.progress + '%'"></div>
            </span>
            <span ng-show="queteur.current.temporary_volunteer_form.result">Upload Successful</span>
            <span class="err" ng-show="errorMsg">{{errorMsg}}</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group" ng-show="queteur.current.secteur >= 3 && queteur.current.age < 18 ">

            <label for="parent_authorization_form" class="control-label">Authorisation Parentale</label>

            <input type="file"
                   name="parent_authorization_form"
                   id="parent_authorization_form"
                   ng-model="parent_authorization_form"
                   ngf-max-size="2MB"
                   ngf-accept="'image/*', 'application/pdf'"
                   ngf-model-invalid="errorFile"
            />


            <span class="help-block">Scanner l'autorisation parentale et ajouter le fichier ici</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8 col-md-offset-2">

          <div class="form-group">
            <label for="notes" class="control-label">Notes</label>
            <textarea rows="6" name="notes" id="notes" class="form-control" ng-model="queteur.current.notes"></textarea>
            <span class="help-block">Info importantes sur le quêteurs, ex: Allergie, Diabétique, Asmathique, Contraintes horaires etc...</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 col-md-offset-2">

          <div class="form-group" ng-show="queteur.current.id">
            <label for="created" class="control-label">Créé le</label>
            <input name="created" id="created" class="form-control" ng-model="queteur.current.created" readonly/>
          </div>
        </div>
        <div class="col-md-4">

          <div class="form-group"ng-show="queteur.current.id">
            <label for="updated" class="control-label">Mise à jour le</label>
            <input name="updated" id="updated" class="form-control" ng-model="queteur.current.updated" readonly/>
          </div>
        </div>
      </div>

      <div class="row" style="margin-bottom: 15px;">
        <div class="col-md-2 col-md-offset-2">
          <a  ng-click="queteur.back();" class="btn btn-link">Cancel</a>
        </div>

        <div class="col-md-2 col-md-offset-2">
          <input type="button" class="btn btn-primary" value="Créer un nouveau quêteur" ng-show="queteur.current.id > 0 " ng-click="queteur.createNewUser()"/>
        </div>
        <div class="col-md-2 col-md-offset-1">
          <input type="button" class="btn btn-primary" value="Save" ng-disabled="queteurForm.$invalid" ng-show="queteur.currentUserRole>1" ng-click='queteur.save();'/>
        </div>
      </div>
      <!-- Successful Save -->
      <div class="row" ng-show="queteur.savedSuccessfully">
        <div class="col-md-8 col-md-offset-2">
          <div class="alert alert-success alert-dismissible" role="alert" style="text-align: center;">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close" ng-click="queteur.savedSuccessfully=false"><span aria-hidden="true">&times;</span></button>
            <strong>Bravo!</strong> Le quêteur a été sauvegardé avec succès!
          </div>
        </div>
      </div>
      <!-- Error while saving -->
      <div class="row" ng-show="queteur.errorWhileSaving">
        <div class="col-md-8 col-md-offset-2">
          <div class="alert alert-danger alert-dismissible" role="alert" style="text-align: center;">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close" ng-click="queteur.errorWhileSaving=false"><span aria-hidden="true">&times;</span></button>
            <strong>Oouupps!</strong> Une erreur est survenue lors de la sauvegarde du quêteur!
            <pre style="text-align: left;">{{queteur.errorWhileSavingDetails}}</pre>
          </div>
        </div>
      </div>


      <!-- RCQ USER -->

      <div ng-show="queteur.current.id > 0 && queteur.current.active == 1 && queteur.current.secteur <= 2 && queteur.currentUserRole >= 4">

        <div class="row">
          <div class="col-md-8 col-md-offset-2">

            <div class="panel" ng-class="{'panel-warning':!queteur.current.user, 'panel-success':queteur.current.user.id>0}">
              <div class="panel-heading">
                <h3 class="panel-title">Application RCQ</h3>
              </div>
              <div class="panel-body">

                <span class="help-block" ng-show="!queteur.current.user">Ce bénévole <b>n'</b>est <b>pas</b> un utilisateur de l'application RCQ</span>
                <span class="help-block" ng-show="queteur.current.user" >Ce bénévole <b>est</b> un utilisateur de l'application RCQ</span>


                <div class="row"  ng-show="!queteur.current.user">
                  <div class="col-md-12 ">
                    <button class="btn btn-default" type="button" id="createUserButton" ng-click="queteur.createUser()">Faire de ce bénévole un utilisateur de l'application RCQ</button>
                    <span class="help-block">
                      En cliquant sur ce bouton :
                      <ul>
                        <li>Le bénévole deviendra un utilisateur de l'application et pourra se connecter à l'application RCQ</li>
                        <li>Il recevera un email avec un lien pour initialiser son mot de passe</li>
                        <li>Par défaut, il sera actif et aura le role "Viewer"</li>
                        <li>L'utilisateur ne pourra plus être supprimé, seulement désactivé</li>
                      </ul>
                    </span>
                  </div>
                </div>


                <div ng-show="queteur.current.user">

                  <div class="panel panel-primary">
                    <div class="panel-heading">Modifications</div>
                    <div class="panel-body">


                      <div class="row">
                        <div class="col-md-4">
                          <label for="userActiveRadio1" class="control-label">Actif</label> <br/>
                          <label class="radio-inline">
                            <input type="radio" name="userActive" id="userActiveRadio1" ng-model="queteur.current.user.active" value="1" ng-required="queteur.current.user"> Oui
                          </label>
                          <label class="radio-inline">
                            <input type="radio" name="userActive" id="userActiveRadio2" ng-model="queteur.current.user.active" value="0" ng-required="queteur.current.user"> Non
                          </label>
                        </div>

                        <div class="form-group col-md-8">
                          <label for="user.role" class="control-label">Rôle de l'utilisateur</label>
                          <!-- (r.id+'') otherwise the value of the option tag is value='number:1' -->
                          <select name="user.role" id="user.role" class="form-control" ng-model="queteur.current.user.role" ng-required="queteur.current.user"
                                  ng-options="(r.id+'') as r.label
                      for
                      r in queteur.roleList">
                            <option value=""></option>
                          </select>

                          <span class="help-block" style="height:38px">{{queteur.roleDesc[queteur.current.user.role]}}</span>
                        </div>
                      </div>
                      <div class="row">
                        <div class="form-group col-md-6">
                          <button class="btn btn-default" type="button" id="reInitUserPassword" ng-click="queteur.reinitPassword()">Ré-initialiser le Password</button>
                          <span class="help-block">Un email sera envoyé à l'utilsateur avec un lien pour réinitialiser son mot de passe</span>
                        </div>

                        <div class="form-group col-md-6">
                          <button class="btn btn-default" type="button" id="userSave" ng-click="queteur.userSave()">Sauvegarder</button>
                          <span class="help-block">L'utilisateur devra se deconnecter/reconnecter pour que la modification soit effective</span>
                        </div>

                      </div>


                    </div>
                  </div> <!-- fin panel Modification -->


                  <div class="panel panel-default">
                    <div class="panel-heading">Informations</div>
                    <div class="panel-body">


                      <div class="row">
                        <div class="col-md-12 ">

                          <label for="password_defined" class="control-label">Password Défini?</label>
                          <input type="checkbox" id="password_defined" name="password_defined" ng-model="queteur.current.user.password_defined" disabled/>

                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">

                          <div class="form-group">
                            <label for="user.created" class="control-label">Créé le</label>
                            <input name="created" id="user.created" class="form-control" ng-model="queteur.current.user.created.date" readonly/>
                          </div>
                        </div>
                        <div class="col-md-6">

                          <div class="form-group">
                            <label for="user.updated" class="control-label">Mise à jour le</label>
                            <input name="updated" id="user.updated" class="form-control" ng-model="queteur.current.user.updated.date" readonly/>
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-6">

                          <div class="form-group">
                            <label for="last_failure_login_date" class="control-label">Dernière authentification échouée</label>
                            <input name="last_failure_login_date" id="last_failure_login_date" class="form-control" ng-model="queteur.current.user.last_failure_login_date.date" readonly/>
                          </div>
                        </div>
                        <div class="col-md-6">

                          <div class="form-group">
                            <label for="last_successful_login_date" class="control-label">Dernière authentification réussie</label>
                            <input name="last_successful_login_date" id="last_successful_login_date" class="form-control" ng-model="queteur.current.user.last_successful_login_date.date" readonly/>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-12 ">

                          <label for="nb_of_failure" class="control-label">Nombre d'authentification échouée</label>
                          <input type="text" id="nb_of_failure" class="form-control" name="nb_of_failure" ng-model="queteur.current.user.nb_of_failure" disabled/>

                        </div>
                      </div>



                    </div>
                  </div> <!-- fin panel information -->


                </div>
              </div>
            </div>
          </div>
        </div>
      </div>




      <div class="row" ng-show="queteur.current.id > 0" style="padding-top:20px;">
        <div class="panel panel-default">
          <!-- Default panel contents -->
          <div class="panel-heading">Listes des troncs ({{::queteur.current.troncs_queteur.length}}) de <b><span ng-bind="queteur.current.first_name"></span> <span ng-bind="queteur.current.last_name"></span></b></div>

          <table class='table'>
            <thead>
              <tr>
                <th>ID (click to edit)</th>
                <th>départ Théorique</th>
                <th>départ</th>
                <th>retour</th>
                <th>durée(min)</th>
                <th>point_quete id</th>
                <th>Montant</th>
                <th>Poids</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="tq in queteur.current.troncs_queteur">
                <th><a ng-href="/#!/tronc_queteur/edit/{{::tq.id}}">{{::tq.id}}</a></th>
                <td>{{::tq.depart_theorique.toDate() | date : 'dd/MM/yyyy HH:mm:ss'}} </td>
                <td>{{::tq.depart.toDate()           | date : 'dd/MM/yyyy HH:mm:ss'}}</td>
                <td>{{::tq.retour.toDate()           | date : 'dd/MM/yyyy HH:mm:ss'}}</td>
                <td>{{::tq.duration.toFixed(2)}}</td>
                <td>{{::tq.point_quete_id}}</td>
                <td>

                  {{(
                  tq.euro500 * 500 +
                  tq.euro200 * 200 +
                  tq.euro100 * 100 +
                  tq.euro50  * 50  +
                  tq.euro20  * 20  +
                  tq.euro10  * 10  +
                  tq.euro5   * 5   +
                  tq.euro2   * 2   +
                  tq.euro1   * 1   +
                  tq.cents50 * 0.5 +
                  tq.cents20 * 0.2 +
                  tq.cents10 * 0.1 +
                  tq.cents5  * 0.05+
                  tq.cents2  * 0.02+
                  tq.cent1   * 0.01+
                  tq.don_cheque    +
                  tq.don_creditcard
                  ).toFixed(2)}}
                  €
                </td>
                <td>

                  {{(tq.euro500 * 1.1  +
                  tq.euro200 * 1.1  +
                  tq.euro100 * 1    +
                  tq.euro50  * 0.9  +
                  tq.euro20  * 0.8  +
                  tq.euro10  * 0.7  +
                  tq.euro5   * 0.6  +
                  tq.euro2   * 8.5  +
                  tq.euro1   * 7.5  +
                  tq.cents50 * 7.8  +
                  tq.cents20 * 5.74 +
                  tq.cents10 * 4.1  +
                  tq.cents5  * 3.92 +
                  tq.cents2  * 3.06 +
                  tq.cent1   * 2.3  ).toFixed(2)}}
                  g
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </form>
  </div>

</div>

